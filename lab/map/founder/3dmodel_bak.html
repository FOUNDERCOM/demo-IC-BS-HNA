<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index, all" />
    <title>ol3cesium example</title>
    <script src="./node_modules/cesium/Build/Cesium/Cesium.js"></script>
    <script src="./public/javascripts/lib/EzMapAPI.js"></script>
    <script type="text/javascript" src="./public/javascripts/lib/FMapClient.js"></script>
    <script src="./public/javascripts/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./public/javascripts/lib/EzServerClient.min.css">
</head>
<style>
    body {
        margin: 0;
        padding: 0;
    }
</style>

<body>
        <input type="button" value="Enable/disable" onclick="javascript:ol3d.setEnabled(!ol3d.getEnabled())" />
        <div id="map" style="width:100%;height:100%;"></div>
        <script>
            var map = new EzMap('map');
            map.centerAndZoom(new EzCoord(106.568, 26.364), 6);
            
    //矢量地图
            wmtslayer = new Ez.TileLayer.WMTS('test', 'http://172.25.16.102:8080/EzServer7/WMTS?SERVICE=WMTS', {
            type: 'wmts',
            crs: '4326',
            wrapX: false,
            layer:'sltdt',
            matrixSet:'c',
            format:'tile',
            style: 'default',
        });
    //影像地图
        //     wmtslayer = new Ez.TileLayer.WMTS('test', 'http://172.25.16.102:8080/EzServer7/WMTS?SERVICE=WMTS', {
        //     type: 'wmts',
        //     crs: '4326',
        //     wrapX: false,
        //     layer:'yxtdt',
        //     matrixSet:'c',
        //     format:'tile',
        //     style: 'default',
        // });
            map.addLayer(wmtslayer);
            var ol3d = new olcs.OLCesium({ map: map });
            var scene = ol3d.getCesiumScene();
            ol3d.setEnabled(true);
      var fixGltf = function(gltf) {
        if (!gltf.extensionsUsed) {
            return;
        }
    
        var v = gltf.extensionsUsed.indexOf('KHR_technique_webgl');
        var t = gltf.extensionsRequired.indexOf('KHR_technique_webgl');
       
        if (v !== -1) {
            gltf.extensionsRequired.splice(t, 1, 'KHR_techniques_webgl');
            gltf.extensionsUsed.splice(v, 1, 'KHR_techniques_webgl');
            gltf.extensions = gltf.extensions || {};
            gltf.extensions['KHR_techniques_webgl'] = {};
            gltf.extensions['KHR_techniques_webgl'].programs = gltf.programs;
            gltf.extensions['KHR_techniques_webgl'].shaders = gltf.shaders;
            gltf.extensions['KHR_techniques_webgl'].techniques = gltf.techniques;
            var techniques = gltf.extensions['KHR_techniques_webgl'].techniques;
    
            gltf.materials.forEach(function (mat, index) {
                gltf.materials[index].extensions['KHR_technique_webgl'].values = gltf.materials[index].values;
                gltf.materials[index].extensions['KHR_techniques_webgl'] = gltf.materials[index].extensions['KHR_technique_webgl'];
    
                var vtxfMaterialExtension = gltf.materials[index].extensions['KHR_techniques_webgl'];
    
                for (var value in vtxfMaterialExtension.values) {
                    var us = techniques[vtxfMaterialExtension.technique].uniforms;
                    for (var key in us) {
                        if (us[key] === value) {
                            vtxfMaterialExtension.values[key] = vtxfMaterialExtension.values[value];
                            delete vtxfMaterialExtension.values[value];
                            break;
                        }
                    }
                };
            });
    
            techniques.forEach(function (t) {
                for (var attribute in t.attributes) {
                    var name = t.attributes[attribute];
                    t.attributes[attribute] = t.parameters[name];
                };
    
                for (var uniform in t.uniforms) {
                    var name = t.uniforms[uniform];
                    t.uniforms[uniform] = t.parameters[name];
                };
            });
        }
    }
    
    Object.defineProperties(Cesium.Model.prototype, {
        _cachedGltf: {
            set: function (value) {
                this._vtxf_cachedGltf = value;
                if (this._vtxf_cachedGltf && this._vtxf_cachedGltf._gltf) {
                    fixGltf(this._vtxf_cachedGltf._gltf);
                }
            },
            get: function () {
                return this._vtxf_cachedGltf;
            }
        }
    });
            var tileset = new Cesium.Cesium3DTileset({ url: "http://172.18.117.97:8080/pgis/data/obq/hn1/tileset.json" });
            scene.primitives.add(tileset);
            scene.camera.flyTo({
                destination:Cesium.Cartesian3.fromDegrees(111.341764,25.269629, 150),
                orientation : {
                    heading : Cesium.Math.toRadians(0.0),
                    pitch : Cesium.Math.toRadians(-25.0),
                    roll : 0.0
                }
    
            })
    
        </script>
    </body>
    
    </html>